<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="/WebResources/dyna_/css/kendo.common.min.css" />
    <!--<link rel="stylesheet" href="/WebResources/dyna_/css/kendo.common.min.css" />-->
    <link rel="stylesheet" href="/WebResources/dyna_/css/kendo.bootstrapv4.min.css" />
    <!--<link rel="stylesheet" href="/WebResources/dyna_/css/kendo.common.min.css" />-->
    <!--<link rel="stylesheet" href="/WebResources/dyna_/css/kendo.bootstrap.min.css" />-->
    <!--<link rel="stylesheet" href="/WebResources/dyna_/css/kendo.common.min.css" />-->
    <!--<link rel="stylesheet" href="css/kendo.default.mobile.min.css" />-->

    <script src="/WebResources/ClientGlobalContext.js.aspx" type="text/javascript"></script>
    <script src="/WebResources/dyna_/scripts/jquery.min.js"></script>
    <script src="/WebResources/dyna_/scripts/json2.js"></script>
    <script src="/WebResources/dyna_/scripts/kendo.all.min.js"></script>


    <style>
        body {
            font-family: Segoe UI,Tahoma,Arial;
            font-weight: normal;
            font-size: 11px;
        }

        #btnExistProduct {
            vertical-align: middle;
            font-size: 11px;
            float: left;
        }

        #btnWriteInProduct {
            vertical-align: middle;
            font-size: 11px;
            float: left;
        }

        /*#opportunityProductDrop {
            vertical-align: middle;
            font-size: 11px;
        }*/

        .refreshBtnContainer {
            display: inline-block;
        }

        .toolbar {
            float: right;
        }

        .k-button {
            font-size: 11px;
        }

        .k-grid-delete {
            padding: 0;
        }

        .k-input {
            font-size: 11px;
        }

        .k-block {
            font-size: 11px;
        }

        .k-widget {
            font-size: 11px;
        }

        .k-grid td {
            padding: .5rem;
        }
    </style>

    <script>
        function GetOpportunityProduct() {

            var ctx = GetCrmContext();
            var serverUrl = location.protocol + "//" + location.host

        }

    </script>

</head>
<body>
    <div id="example">

        <script type="text/x-kendo-template" id="template">
            <div class="refreshBtnContainer">
                <a role="button" title="Save" style="background-color:\\#298040" class="k-button k-button-icontext k-grid-save-changes" href="\\#"><span class="k-icon k-i-check"></span>Save Changes</a>
                <a role="button" title="Cancel" style="background-color:\\#a73232" class="k-button k-button-icontext k-grid-cancel-changes" href="\\#"><span class="k-icon k-i-cancel"></span>Cancel Changes</a>
            </div>
            <div class="toolbar">
                <!--<a href="\\#" class="k-pager-refresh k-link k-button" onchange="OnChange" title="plus"><span class="k-icon k-i-add"></span></a>-->
                <!--<input id="opportunityProductDrop" style="width: 200px" />-->
                <input id="btnExistProduct" class="k-button" onclick="ExistProduct();" type="button" name="existProduct" value="Existing Product" />
                <input id="btnWriteInProduct" class="k-button" onclick="WriteInProduct();" type="button" name="writeInProduct" value="Write-in Product" />
                <a href="\\#" class="k-pager-refresh k-link k-button" title="Refresh"><span class="k-icon k-i-reload"></span></a>
            </div>
        </script>

        <div id="grid"></div>

        <script>

            var valuta = "EUR";
            var isDefaultValueAdded = false;

            var parameters = GetGlobalContext().getQueryStringParameters();

            var opportynityId = parameters.id != undefined ? parameters.id : "2561A578-9813-E711-9D4A-005056BE4EEC";
            var priceLevelId = window.parent.Xrm.Page.getAttribute("pricelevelid").getValue() != null ? window.parent.Xrm.Page.getAttribute("pricelevelid").getValue()[0].id : "3ED0C142-7CFB-E311-A1B8-005056AD7E30";
            priceLevelId = priceLevelId.replace("{", "").replace("}", "");
            var oumId = "5F4EFA02-9DEF-4FFA-BC89-E086D690B614";

            var ParseParameters = function (Query) {
                try {
                    var ResultParameters = {};

                    //NULL CHECK
                    if (Query != undefined && Query != null) {

                        //SPLIR PARAMETERS
                        var QuerySplit = Query.split("&");

                        //PARSE PARAMETERS TO ARRAY
                        for (var i = 0; i < QuerySplit.length; i++) {
                            var ParameterPair = QuerySplit[i].split("=");
                            ResultParameters[ParameterPair[0]] = ParameterPair.length > 1 ? ParameterPair[1] : null;
                        }
                    }
                    return ResultParameters;

                }
                catch (error) {
                    errorHandler(error);
                }
            }

            $(document).ready(function () {
                var ctx = GetCrmContext();
                var serverUrl = location.protocol + "//" + location.host;

                var dataSource = new kendo.data.DataSource({
                    transport: {
                        read: function (options) {
                            $.ajax({
                                type: "GET",
                                contentType: "application/json; charset=utf-8",
                                datatype: "json",
                                url: serverUrl + "/XRMServices/2011/OrganizationData.svc/OpportunityProductSet?$select=UoMId,dyna_CustomerPrice,BaseAmount,Description,ProductDescription,dyna_ExpectedDeliveryDate,dyna_Status,ExtendedAmount,IsPriceOverridden,IsProductOverridden,ManualDiscountAmount,OpportunityId,OpportunityProductId,PricePerUnit,ProductDescription,ProductId,ProductTypeCode,Quantity&$filter=OpportunityId/Id eq (guid'" + opportynityId + "')&$orderby=dyna_ExpectedDeliveryDate desc",
                                beforeSend: function (XMLHttpRequest) {
                                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                                },
                                async: true,
                                success: function (data, textStatus, xhr) {
                                    var results = data.d.results;
                                    var resultOpp = [];
                                    for (var i = 0; i < results.length; i++) {
                                        var dyna_Status = results[i].dyna_Status;
                                        var baseAmount = results[i].BaseAmount;
                                        var description = results[i].Description;
                                        var isPriceOverridden = results[i].IsPriceOverridden;
                                        var isProductOverridden = results[i].IsProductOverridden;
                                        var dyna_ExpectedDeliveryDate = results[i].dyna_ExpectedDeliveryDate;
                                        var extendedAmount = results[i].ExtendedAmount;
                                        var manualDiscountAmount = results[i].ManualDiscountAmount;
                                        var opportunityId = results[i].OpportunityId;
                                        var opportunityProductId = results[i].OpportunityProductId;
                                        var pricePerUnit = results[i].PricePerUnit;
                                        var productDescription = results[i].ProductDescription;
                                        var productId = results[i].ProductId;
                                        var productTypeCode = results[i].ProductTypeCode;
                                        var quantity = results[i].Quantity;
                                        var productdescription = results[i].ProductDescription;
                                        var dyna_CustomerPrice = results[i].dyna_CustomerPrice;
                                        var uoMId = results[i].UoMId;

                                        var resultItem = {};
                                        resultItem.uoMId = uoMId != null ? uoMId.Id : "";
                                        resultItem.baseAmount = baseAmount.Value;
                                        resultItem.extendedAmount = extendedAmount.Value;
                                        resultItem.dyna_StatusName = SetStatusLabel(dyna_Status.Value);
                                        resultItem.dyna_Status = dyna_Status.Value.toString(), //SetStatusLabel(dyna_Status.Value);
                                        resultItem.currency = valuta,
                                        resultItem.description = productdescription;
                                        resultItem.isPriceOverridden = isPriceOverridden;
                                        resultItem.dyna_ExpectedDeliveryDate = dyna_ExpectedDeliveryDate;
                                        resultItem.isProductOverridden = isProductOverridden;
                                        resultItem.manualDiscountAmount = manualDiscountAmount.Value;
                                        resultItem.opportunityId = opportunityId.Id;
                                        resultItem.opportunityIdName = opportunityId.Name;
                                        resultItem.opportunityProductId = opportunityProductId;
                                        resultItem.pricePerUnit = pricePerUnit.Value;
                                        resultItem.productDescription = productDescription;
                                        resultItem.productId = productId != null ? productId.Id : "";
                                        resultItem.productIdName = productId != null ? productId.Name : "";
                                        resultItem.productTypeCode = productTypeCode != null ? productTypeCode.Value : null;
                                        resultItem.quantity = quantity;
                                        resultItem.dyna_CustomerPrice = dyna_CustomerPrice.Value != null ? dyna_CustomerPrice.Value : Number("0.00");
                                        resultItem.manualDiscountProcentage = (parseFloat(manualDiscountAmount.Value) / (parseFloat(manualDiscountAmount.Value) + parseFloat(extendedAmount.Value))) * 100;


                                        resultOpp.push(resultItem);
                                    }

                                    options.success(resultOpp);
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                                }
                            });
                        },
                        change: function (e) {
                            alert("change");
                        },
                        update: function (options) {
                            var item = options.data;

                            item.extendedAmount = (parseFloat(item.quantity).toFixed(0) * parseFloat(item.pricePerUnit).toFixed(2)) - parseFloat(item.manualDiscountAmount).toFixed(2);

                            var entity = {};

                            if (item.productId != null) {
                                entity.ProductId = {
                                    Id: item.productId,
                                    LogicalName: "product"
                                };

                                entity.UoMId = {
                                    Id: item.uoMId,
                                    LogicalName: "uom"
                                };


                            }

                            entity.ProductDescription = item.description != null ? item.description : "";
                            entity.Quantity = parseFloat(item.quantity).toFixed(0);

                            if (item.dyna_ExpectedDeliveryDate != "") {
                                var d = item.dyna_ExpectedDeliveryDate;
                                entity.dyna_ExpectedDeliveryDate = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
                            }

                            //entity.BaseAmount = {
                            //    Value: parseFloat(item.baseAmount).toFixed(2)
                            //};
                            entity.OpportunityId = {
                                Id: item.opportunityId,
                                LogicalName: "opportunity"
                            };
                            entity.IsPriceOverridden = item.IsPriceOverridden == true ? true : false;
                            entity.PricePerUnit = {
                                Value: parseFloat(item.pricePerUnit).toFixed(2)
                            };
                            entity.ManualDiscountAmount = {
                                Value: parseFloat(item.manualDiscountAmount).toFixed(2)
                            };

                            entity.dyna_Status = {
                                Value: parseInt(item.dyna_Status)
                            };

                            $.ajax({
                                type: "POST",
                                contentType: "application/json; charset=utf-8",
                                datatype: "json",
                                url: serverUrl + "/XRMServices/2011/OrganizationData.svc/OpportunityProductSet(guid'" + item.opportunityProductId + "')",
                                data: JSON.stringify(entity),
                                beforeSend: function (XMLHttpRequest) {
                                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                                    XMLHttpRequest.setRequestHeader("X-HTTP-Method", "MERGE");
                                },
                                async: true,
                                success: function (data, textStatus, xhr) {
                                    options.success(item);

                                    var grid = $("#grid").data("kendoGrid").dataSource;
                                    grid.read();

                                    var sum = 0;
                                    for (var i = 0; i < grid.data().length; i++) {
                                        sum += grid.data()[i].extendedAmount;
                                    }
                                    window.parent.Xrm.Page.getAttribute("totalamount").setValue(sum);
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    //Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                                    $("#grid").data("kendoGrid").dataSource.read();
                                }
                            });


                        },
                        destroy: function (options) {

                            var item = options.data;
                            $.ajax({
                                type: "POST",
                                contentType: "application/json; charset=utf-8",
                                datatype: "json",
                                url: Xrm.Page.context.getClientUrl() + "/XRMServices/2011/OrganizationData.svc/OpportunityProductSet(guid'" + item.opportunityProductId + "')",
                                beforeSend: function (XMLHttpRequest) {
                                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                                    XMLHttpRequest.setRequestHeader("X-HTTP-Method", "DELETE");
                                },
                                async: true,
                                success: function (data, textStatus, xhr) {
                                    options.success(item);

                                    var grid = $("#grid").data("kendoGrid").dataSource;
                                    grid.read();

                                    var sum = 0;
                                    for (var i = 0; i < grid.data().length; i++) {
                                        sum += grid.data()[i].extendedAmount;
                                    }
                                    window.parent.Xrm.Page.getAttribute("totalamount").setValue(sum);

                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    //Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                                    $("#grid").data("kendoGrid").dataSource.read();
                                }
                            });
                        },
                        create: function (options) {

                            //var value = $("#opportunityProductDrop").val();
                            var item = options.data;


                            item.extendedAmount = (parseFloat(item.quantity).toFixed(0) * parseFloat(item.pricePerUnit).toFixed(2)) - parseFloat(item.manualDiscountAmount).toFixed(2);
                            item.currency = valuta;

                            var entity = {};

                            if (item.productId != "") {
                                entity.ProductId = {
                                    Id: item.productId,
                                    LogicalName: "product"
                                };


                                entity.UoMId = {
                                    Id: item.uoMId,
                                    LogicalName: "uom"
                                };
                            }

                            entity.ProductDescription = item.description != "" ? item.description : "";
                            entity.Quantity = parseFloat(item.quantity).toFixed(0);
                            entity.IsProductOverridden = item.isProductOverridden; // Existing
                            entity.IsPriceOverridden = item.isPriceOverridden; //Use default

                            if (item.dyna_ExpectedDeliveryDate != "") {
                                var d = item.dyna_ExpectedDeliveryDate;
                                entity.dyna_ExpectedDeliveryDate = (d.getMonth() + 1) + "/" + d.getDate() + "/" + d.getFullYear();
                            }

                            //entity.BaseAmount = {
                            //    Value: parseFloat(item.baseAmount).toFixed(2)
                            //};
                            entity.OpportunityId = {
                                Id: opportynityId,
                                LogicalName: "opportunity"
                            };
                            entity.PricePerUnit = {
                                Value: parseFloat(item.pricePerUnit).toFixed(2)
                            };
                            entity.ManualDiscountAmount = {
                                Value: parseFloat(item.manualDiscountAmount).toFixed(2)
                            };

                            entity.dyna_Status = {
                                Value: parseInt(item.dyna_Status)
                            };

                            $.ajax({
                                type: "POST",
                                contentType: "application/json; charset=utf-8",
                                datatype: "json",
                                url: serverUrl + "/XRMServices/2011/OrganizationData.svc/OpportunityProductSet",
                                data: JSON.stringify(entity),
                                beforeSend: function (XMLHttpRequest) {
                                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                                },
                                async: true,
                                success: function (data, textStatus, xhr) {
                                    var result = data.d;
                                    var newEntityId = result.OpportunityProductId;

                                    //var ddl = $("#opportunityProductDrop").data("kendoDropDownList");
                                    //ddl.value(-1);
                                    isDefaultValueAdded = false;
                                    options.success(item);
                                    var grid = $("#grid").data("kendoGrid").dataSource;
                                    grid.read();

                                    var sum = 0;
                                    for (var i = 0; i < grid.data().length; i++) {
                                        sum += grid.data()[i].extendedAmount;
                                    }
                                    window.parent.Xrm.Page.getAttribute("totalamount").setValue(sum);
                                },
                                error: function (xhr, textStatus, errorThrown) {
                                    //Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                                    $("#grid").data("kendoGrid").dataSource.read();
                                }
                            });

                        },
                        parameterMap: function (options, operation) {
                            if (operation !== "read" && options.models) {
                                return { models: kendo.stringify(options.models) };
                            }
                        }
                    },
                    batch: false,
                    pageSize: 20,
                    schema: {
                        model: {
                            id: "opportunityProductId",
                            fields: {
                                isProductOverridden: { type: "boolean", editable: true, nullable: true },
                                isPriceOverridden: { type: "boolean", editable: true, nullable: true },
                                currency: { type: "string", editable: false },
                                productId: { type: "string" },
                                uoMId: { type: "string" },
                                productIdName: { editable: true, type: "string" },
                                description: { editable: true, type: "string" },
                                pricePerUnit: { editable: true, type: "number", validation: { min: 1 } },
                                quantity: { type: "number", validation: { min: 1, required: true } },
                                manualDiscountAmount: { type: "number", validation: { required: true, min: 0 } },
                                manualDiscountProcentage: { type: "number", validation: { required: false, min: 0 } },
                                extendedAmount: { type: "number", editable: false, validation: { required: true, min: 1 } },
                                dyna_CustomerPrice: { type: "number", editable: false, validation: { required: true, min: 1 } },
                                dyna_StatusName: { type: "string", editable: true },
                                dyna_Status: { type: "string" },
                                dyna_ExpectedDeliveryDate: { type: "date", editable: true }
                            }
                        }
                    }
                });



                var grid = $("#grid").kendoGrid({
                    dataSource: dataSource,
                    navigatable: true,
                    pageable: true,
                    height: 300,
                    toolbar: kendo.template($("#template").html()), //["create", "save", "cancel"],
                    dataBound: OnDataBound,
                    edit: function (e) {

                        if (e.model.isNew()) {
                            // Disable the editor of the "id" column when editing data items


                            if (!productState || !e.model.isProductOverridden) {
                                e.model.set("isPriceOverridden", false);
                                $("input[name=description]").parent().html("");
                            }
                            else if (productState || e.model.isProductOverridden) {
                                e.model.set("isPriceOverridden", true);
                                $("input[aria-owns=productDrop_listbox]").parent().html("");

                            }

                            if (!e.model.isPriceOverridden) { //($(".k-grid-edit-row td span:eq(1)")[0].innerText == "No" || $(".k-grid-edit-row td span:eq(1)")[0].innerText == "") {
                                if (e.sender._lastCellIndex == 3) {
                                    this.closeCell();
                                }
                            }

                            if (!isDefaultValueAdded) {
                                e.model.set("quantity", parseFloat(1).toFixed(0));
                                e.model.set("currency", valuta);
                                e.model.set("dyna_Status", "1");
                                e.model.set("dyna_StatusName", "Open");
                                isDefaultValueAdded = true;
                                e.model.set("isProductOverridden", productState);
                                e.model.set("isPriceOverridden", productState);
                            }
                        }
                        else if (!e.model.isNew()) {
                            if ($(".k-grid-edit-row td:eq(0)")[0].innerText != "Yes") {
                                if (e.sender._lastCellIndex == 3) {
                                    this.closeCell();
                                }
                            }

                        }
                    },
                    columns: [
                       /*0*/ { field: "isPriceOverridden", editor: customBoolEditor, template: '<span>#= isPriceOverridden ? "Yes" : "No"#</span>', title: "Price Overriden", width: 50 },
                       /*1*/ { field: "productIdName", title: "Existing Product", template: '#=productIdName == null ? "" : productIdName#', editor: customBoolDropDrown, width: 120 },
                       /*2*/ { field: "description", title: "Write-In Product", width: 120 },
                             //{ field: "currency", title: "-", width: 50 },
                       /*3*/ { field: "pricePerUnit", title: "SSP", format: "{0:n}", width: 60, editor: PriceEditor },
                       /*4*/ { field: "manualDiscountProcentage", title: "Discount %", format: "{0:n} %", width: 60, editor: DiscountEditor },
                       /*5*/ { field: "dyna_CustomerPrice", title: "Customer Price", format: "{0:n}", width: 60 },
                       /*6*/ { field: "quantity", title: "Quantity", width: 60, editor: QuantityEditor },
                       /*7*/ { field: "extendedAmount", title: "Total Line Amount", format: "{0:n}", width: 60 },
                       /*8*/ { field: "dyna_StatusName", editor: customDropDownStatus, title: "Status", width: 70 },
                       /*9*/ { field: "dyna_ExpectedDeliveryDate", title: "Expected Shipment Date", format: "{0:dd-MM-yyyy}", width: 100 },
                      /*10*/ { field: "manualDiscountAmount", hidden: true, title: "Discount Amount", format: "{0:n}", width: 60, editor: DiscountEditor },
                      /*11*/ { command: { text: "Delete", click: DeleteRow }, title: "&nbsp;", width: 50, template: "<div class='k-button'><span class='k-icon k-delete'></span></div>" }
                        //{ command: "destroy", title: "&nbsp;", width: 50, editor: '<input id="btnDelete" class="k-button" onclick="DeleteRow(this);" type="button" name="existProduct" value="Delete" />' }
                    ],
                    editable: true
                });


                function PriceEditor(container, options) {
                    $('<input data-bind="value:' + options.field + '"/>')
                        .appendTo(container)
                        .kendoNumericTextBox({
                            decimals: 2,
                            format: "n",
                            change: PriceChange,
                            spin: PriceChange
                        });
                }


                function QuantityEditor(container, options) {
                    $('<input data-bind="value:' + options.field + '"/>')
                        .appendTo(container)
                        .kendoNumericTextBox({
                            decimals: 2,
                            format: "n",
                            change: QuantityChange,
                            spin: QuantityChange
                        });
                }

                function DiscountEditor(container, options) {
                    $('<input data-bind="value:' + options.field + '"/>')
                        .appendTo(container)
                        .kendoNumericTextBox({
                            format: "n0",
                            min: 0,
                            max: 100,
                            //step: 0.01,
                            change: DicountChange,
                            spin: DicountChange
                        });
                }


                var data = [
                            { text: "Existing Product", value: "1" },
                            { text: "Write-in Product", value: "2" }
                ];

                var dropDown = grid.find("#opportunityProductDrop").kendoDropDownList({
                    optionLabel: "Add Opportunity Product",
                    dataTextField: "text",
                    dataValueField: "value",
                    dataSource: data,
                    index: 0,
                    change: onChange
                });

                grid.find(".k-grid-toolbar").on("click", ".k-pager-refresh", function (e) {
                    e.preventDefault();
                    grid.data("kendoGrid").dataSource.read();
                });
            });

            $("#grid").on("mousedown", ".k-grid-cancel-changes", function (e) {
                var ddl = $("#opportunityProductDrop").data("kendoDropDownList");
                ddl.value(-1);
            });

            //$("#grid").on("click", ".k-grid-delete", function (e) {
            //    $("#grid").data("kendoGrid").saveChanges();
            //});




            function PriceChange() {
                var e = this.element;
                var grid = $("#grid").data("kendoGrid").dataItem($(e).closest("tr"));
                var element = grid.uid; // $($("#grid").data("kendoGrid").current()[0]).closest("tr").attr("data-uid");

                var discount = (parseFloat($(e).data("kendoNumericTextBox").value()).toFixed(2) * parseFloat(grid.quantity).toFixed(0)) * parseFloat(grid.manualDiscountProcentage / 100);
                var total = (parseFloat($(e).data("kendoNumericTextBox").value()).toFixed(2) * parseFloat(grid.quantity).toFixed(0)) - discount;

                var customerPrice = parseFloat(total).toFixed(2) / parseFloat(grid.quantity).toFixed(0);

                $("#grid").find("tr[data-uid='" + element + "'] td:eq(7)").text(parseFloat(total).toFixed(2));
                $("#grid").find("tr[data-uid='" + element + "'] td:eq(5)").text(parseFloat(customerPrice).toFixed(2));
                grid.extendedAmount = parseFloat(total).toFixed(2);
                grid.manualDiscountAmount = parseFloat(discount).toFixed(2);
                grid.dyna_CustomerPrice = parseFloat(customerPrice).toFixed(2);
            }

            function QuantityChange() {

                var e = this.element;
                var grid = $("#grid").data("kendoGrid").dataItem($(e).closest("tr"));
                var element = grid.uid; // $($("#grid").data("kendoGrid").current()[0]).closest("tr").attr("data-uid");

                var discount = (parseFloat(grid.pricePerUnit).toFixed(2) * parseFloat($(e).data("kendoNumericTextBox").value().toFixed(0))) * parseFloat(grid.manualDiscountProcentage / 100);
                var total = (parseFloat(grid.pricePerUnit).toFixed(2) * parseFloat($(e).data("kendoNumericTextBox").value()).toFixed(0)) - discount;
                var customerPrice = parseFloat(total).toFixed(2) / parseFloat($(e).data("kendoNumericTextBox").value().toFixed(0));

                $("#grid").find("tr[data-uid='" + element + "'] td:eq(7)").text(parseFloat(total).toFixed(2));
                $("#grid").find("tr[data-uid='" + element + "'] td:eq(5)").text(parseFloat(customerPrice).toFixed(2));
                grid.extendedAmount = parseFloat(total).toFixed(2);
                grid.manualDiscountAmount = parseFloat(discount).toFixed(2);
                grid.dyna_CustomerPrice = parseFloat(customerPrice).toFixed(2);
            }

            function DicountChange() {

                var e = this.element;
                var grid = $("#grid").data("kendoGrid").dataItem($(e).closest("tr"));
                var element = grid.uid; // $($("#grid").data("kendoGrid").current()[0]).closest("tr").attr("data-uid");

                var discount = (parseFloat(grid.pricePerUnit).toFixed(2) * parseFloat(grid.quantity).toFixed(0)) * parseFloat($(e).data("kendoNumericTextBox").value() / 100);
                var total = (parseFloat(grid.pricePerUnit).toFixed(2) * parseFloat(grid.quantity).toFixed(0)) - discount;
                var customerPrice = parseFloat(total).toFixed(2) / parseFloat(grid.quantity).toFixed(0);

                $("#grid").find("tr[data-uid='" + element + "'] td:eq(7)").text(parseFloat(total).toFixed(2));
                $("#grid").find("tr[data-uid='" + element + "'] td:eq(5)").text(parseFloat(customerPrice).toFixed(2));


                grid.extendedAmount = parseFloat(total).toFixed(2);
                grid.manualDiscountAmount = parseFloat(discount).toFixed(2);

                grid.dyna_CustomerPrice = parseFloat(customerPrice).toFixed(2);
            }

            function onChange() {

                if ($("#opportunityProductDrop").length != 0) {
                    var value = $("#opportunityProductDrop").val();
                    var grid = $("#grid").data("kendoGrid");


                    if (value == 1 || value == 2) {
                        isDefaultValueAdded = false;
                        grid.addRow();

                        if (value == 1) {
                            $(".k-grid-edit-row td:eq(1)").focus()
                        }
                    }
                }
            }

            function OnDataBound(e) {
                $(".k-grid-Delete").find("span").addClass("k-icon k-delete");
            }

            function DeleteRow(e) {
                var grid = $("#grid").data("kendoGrid");
                var tr = $(e.currentTarget).parent().closest("tr");
                grid.removeRow(tr);

                $("#grid").data("kendoGrid").saveChanges();
            }

            var productState = false;
            function ExistProduct() {
                productState = false;
                var grid = $("#grid").data("kendoGrid");
                isDefaultValueAdded = false;
                grid.addRow();
            }

            function WriteInProduct() {
                productState = true;
                var grid = $("#grid").data("kendoGrid");
                isDefaultValueAdded = false;
                grid.addRow();
            }

            function customBoolEditor(container, options) {
                var guid = kendo.guid();
                $('<input onchange="EnableSellingPrice(this);" class="" id="' + guid + '" type="checkbox" name="isPriceOverridden" data-type="boolean" data-bind="checked:isPriceOverridden">').appendTo(container);
            }

            function EnableSellingPrice(e) {

                var grid = $("#grid").data("kendoGrid").dataItem($(e).closest("tr"));
                var element = $($("#grid").data("kendoGrid").current()[0]).closest("tr").attr("data-uid");
                //grid.pricePerUnit = parseFloat(dataItem.amount).toFixed(2);
                grid.IsPriceOverridden = e.checked ? true : false;

                //$("#grid").find("tr[data-uid='" + element + "'] td:eq(4)").text(parseFloat(dataItem.amount).toFixed(2));
                //$("#grid").find("tr[data-uid='" + element + "'] td:eq(5)").text(grid.quantity);
            }

            var dataStatus = [
                            { text: "Open", value: "1" },
                            { text: "Delivered", value: "2" },
                            { text: "Cancelled", value: "3" },
            ];

            function customDropDownStatus(container, options) {

                $('<input id="dyna_Status" data-text-field="text" data-value-field="value" data-bind="value:dyna_Status "/>').appendTo(container)
                .kendoComboBox({
                    dataTextField: "text",
                    dataValueField: "value",
                    change: function (e) {
                        options.model["dyna_StatusName"] = e.sender.text();
                    },
                    index: 1,
                    dataSource: dataStatus,
                });
            }


            var proId = null
            function customBoolDropDrown(container, options) {

                var ctx = GetCrmContext();
                var serverUrl = location.protocol + "//" + location.host;

                $('<input id="productDrop" data-text-field="productIdName" data-value-field="productId" data-bind="value:productId "/>').appendTo(container)
                .kendoComboBox({
                    placeholder: "Select product",
                    dataTextField: "productIdName",
                    dataValueField: "productId",
                    change: function (e) {
                        options.model["productIdName"] = e.sender.text();
                    },
                    select: onSelectProduct,
                    //filter: "contains",
                    //autoBind: false,
                    //minLength: 3,
                    dataSource: {
                        //serverFiltering: true,
                        transport: {
                            read: function (option) {
                                //$.ajax({
                                //    type: "GET",
                                //    contentType: "application/json; charset=utf-8",
                                //    datatype: "json",
                                //    url: Xrm.Page.context.getClientUrl() + "/XRMServices/2011/OrganizationData.svc/ProductPriceLevelSet?$select=UoMId,UoMScheduleId,Amount,PriceLevelId,ProductId,product_price_levels/Name,product_price_levels/ProductId&$expand=product_price_levels&$filter=PriceLevelId/Id eq (guid'" + priceLevelId + "')&$orderby=ProductId asc",
                                //    beforeSend: function (XMLHttpRequest) {
                                //        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                                //    },
                                //    success: function (data, textStatus, xhr) {
                                //        var results = data.d.results;
                                //        var resultPro = [];

                                //        for (var i = 0; i < results.length; i++) {
                                //            var amount = results[i].Amount;
                                //            var priceLevelId = results[i].PriceLevelId;
                                //            var productId = results[i].ProductId;
                                //            var uoMId = results[i].UoMId;
                                //            var uoMScheduleId = results[i].UoMScheduleId;
                                //            var product_price_levels_Name = results[i].product_price_levels.Name;
                                //            var product_price_levels_ProductId = results[i].product_price_levels.ProductId;

                                //            var resultItem = {};
                                //            resultItem.uoMId = uoMId != null ? uoMId.Id : "";
                                //            resultItem.uoMScheduleId = uoMScheduleId;
                                //            resultItem.productIdName = productId.Name;
                                //            resultItem.productId = productId.Id;
                                //            resultItem.amount = amount.Value;
                                //            resultPro.push(resultItem);
                                //        }

                                //        option.success(resultPro);

                                //    },
                                //    error: function (xhr, textStatus, errorThrown) {
                                //        Xrm.Utility.alertDialog(textStatus + " " + errorThrown);
                                //    }
                                //});

                                option.success(resultPro);
                            }
                        }
                    }
                });
            }

            var productOdataUrl = Xrm.Page.context.getClientUrl() + "/XRMServices/2011/OrganizationData.svc/ProductPriceLevelSet?$select=UoMId,UoMScheduleId,Amount,PriceLevelId,ProductId,product_price_levels/Name,product_price_levels/ProductId&$expand=product_price_levels&$filter=PriceLevelId/Id eq (guid'" + priceLevelId + "')&$orderby=ProductId asc";
            var resultPro = [];
            var DatasourceProduct = function () {
                
                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    datatype: "json",
                    url: productOdataUrl,
                    beforeSend: function (XMLHttpRequest) {
                        XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    },
                    success: function (data, textStatus, xhr) {
                        var results = data.d.results;
                        

                        for (var i = 0; i < results.length; i++) {
                            var amount = results[i].Amount;
                            var priceLevelId = results[i].PriceLevelId;
                            var productId = results[i].ProductId;
                            var uoMId = results[i].UoMId;
                            var uoMScheduleId = results[i].UoMScheduleId;
                            var product_price_levels_Name = results[i].product_price_levels.Name;
                            var product_price_levels_ProductId = results[i].product_price_levels.ProductId;

                            var resultItem = {};
                            resultItem.uoMId = uoMId != null ? uoMId.Id : "";
                            resultItem.uoMScheduleId = uoMScheduleId;
                            resultItem.productIdName = productId.Name;
                            resultItem.productId = productId.Id;
                            resultItem.amount = amount.Value;
                            resultPro.push(resultItem);
                        }

                        if (data.d.__next != null) {
                            productOdataUrl = data.d.__next;
                            DatasourceProduct();
                        }
                    }
                })
            }

            DatasourceProduct();


            function onChangeProduct(e) {
                //var value = $(e).val();
                var grid = $("#grid").data("kendoGrid");
            };

            function onSelectProduct(e) {

                if (e.item) {

                    var dataItem = this.dataItem(e.item.index());
                    var grid = $("#grid").data("kendoGrid").dataItem(this.element.closest("tr"));
                    var element = grid.uid;// $($("#grid").data("kendoGrid").current()[0]).closest("tr").attr("data-uid");
                    grid.pricePerUnit = parseFloat(dataItem.amount).toFixed(2);
                    grid.quantity = parseFloat(1).toFixed(0);
                    grid.uoMId = dataItem.uoMId;

                    var total = grid.pricePerUnit * grid.quantity;

                    $("#grid").find("tr[data-uid='" + element + "'] td:eq(3)").text(parseFloat(dataItem.amount).toFixed(2));
                    $("#grid").find("tr[data-uid='" + element + "'] td:eq(6)").text(grid.quantity);
                    $("#grid").find("tr[data-uid='" + element + "'] td:eq(5)").text(parseFloat(total).toFixed(2));
                    $("#grid").find("tr[data-uid='" + element + "'] td:eq(7)").text(parseFloat(total).toFixed(2));

                    grid.extendedAmount = parseFloat(total).toFixed(2);

                } else {
                    //kendoConsole.log("event :: select");
                }


            };

            function SetStatusLabel(val) {
                var label = "";

                switch (val) {
                    case 1: label = "Open"; break;
                    case 2: label = "Delivered"; break;
                    case 3: label = "Cancelled"; break;
                    default: label = ""; break;

                }

                return label;
            }

            function GetCrmContext() {
                var errorMessage = "Context is not available.";
                if (typeof GetGlobalContext != "undefined")
                { return GetGlobalContext(); }
                else
                {
                    if (typeof Xrm != "undefined") {
                        return Xrm.Page.context;
                    }
                    else { throw new Error(errorMessage); }
                }
            }

        </script>
    </div>


</body>
</html>